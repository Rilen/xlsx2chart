<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Excel Evolução por Subcategoria - 1.02</title>
    <!-- Carregando Bootstrap via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Carregando Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" crossorigin="anonymous"></script>
    <style>
      /* Estilos para o Dashboard */
      .navbar-brand {
        padding-top: .75rem;
        padding-bottom: .75rem;
        font-size: 1rem;
        background-color: rgba(0, 0, 0, .25);
        box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
      }
      main {
        padding-top: 2rem;
      }
      .upload-area {
        padding: 10px 20px;
        border: 2px dashed #0d6efd;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 0px; /* Ajuste para melhor alinhamento */
      }
      .upload-area label {
        cursor: pointer;
        margin-bottom: 0;
      }
      .error-message {
        color: #dc3545;
        font-weight: bold;
        margin-top: 10px;
        text-align: center;
      }
      /* Força proporção 1:1 para pizza/rosca e garante responsividade */
      #chart-area {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 75%; /* Proporção mais amigável para telas */
      }
      .chart-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        max-height: none !important;
      }

      /* Estilo para centralizar no mobile */
      @media (max-width: 768px) {
        .upload-area {
          margin-top: 1rem;
          margin-bottom: 1rem;
        }
        .control-group-item {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-12 me-0 px-3 text-center" href="#">Dashboard Excel Evolução Agrupada</a>
    </header>
    <div class="container-fluid">
      <div class="row">
        <main class="col-12 px-md-4">
          <!-- H1 Centralizado -->
          <h1 class="h2 text-center">Quantidade X Mês e Contribuição de Subcategoria</h1>
          
          <!-- Elementos de Controle Centralizados -->
          <div class="d-flex justify-content-center flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom gap-4">
            
            <!-- 1. Dropdown de Tipo de Gráfico -->
            <div class="d-flex align-items-center control-group-item">
              <label for="chart-type-select" class="form-label mb-0 me-2">Tipo de Gráfico:</label>
              <select id="chart-type-select" class="form-select form-select-sm d-inline-block w-auto">
                <option value="bar">Barra Empilhada (Mês/Subcategoria)</option>
                <option value="line">Linha</option>
                <option value="pie">Pizza (Total Geral)</option>
                <option value="doughnut">Rosca (Total Geral)</option>
              </select>
            </div>
            
            <!-- 2. Upload Area (com ID de status corrigido) -->
            <div class="upload-area control-group-item">
              <label for="excel-upload" class="btn btn-sm btn-primary">
                <span data-feather="upload"></span>
                Fazer Upload do arquivo XLSX Mês/Ano
              </label>
              <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display:none;" />
              <!-- ID corrigido para 'upload-message-status' -->
              <div class="mt-2" id="upload-message-status">Aguardando Upload...</div>
            </div>
            
            <!-- 3. Link de Exemplo (agora alinhado com os outros) -->
            <div class="control-group-item text-center">
              link do arquivo exemplo <a href="https://rilen.github.io/xlsx2chart/venda.xlsx" target="_blank">XLSX</a>
            </div>
            
          </div>

          <div id="error-message" class="error-message"></div>
          <div id="chart-area" class="my-4 w-100">
            <canvas id="myChart" class="chart-canvas"></canvas>
            <h3 class="text-center text-muted pt-5" id="initial-message">Faça o upload do arquivo para visualizar o dashboard.</h3>
          </div>

          <h2 class="mt-5">Quantidade Consolidada por Mês</h2>
          <div class="table-responsive">
            <table class="table table-striped table-sm" id="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Mês/Ano</th>
                  <th>Quantidade Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3">Nenhum dado mensal consolidado encontrado.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      // Variáveis globais
      let myChart = null;
      let processedData = null; // Armazena os dados processados para permitir a troca de gráfico

      document.addEventListener('DOMContentLoaded', () => {
        // Inicializa Feather Icons
        if (typeof feather !== 'undefined') {
          feather.replace();
        }

        const uploadInput = document.getElementById('excel-upload');
        const chartTypeSelect = document.getElementById('chart-type-select');
        const uploadStatus = document.getElementById('upload-message-status');
        const initialMessage = document.getElementById('initial-message');
        const errorMessageDiv = document.getElementById('error-message');
        const chartCanvas = document.getElementById('myChart');

        // Função para gerar cores dinâmicas
        const dynamicColors = () => {
          const r = Math.floor(Math.random() * 255);
          const g = Math.floor(Math.random() * 255);
          const b = Math.floor(Math.random() * 255);
          return `rgb(${r},${g},${b})`;
        };

        // Função para formatar a data (AAAA-MM-DD para MM/AAAA)
        const formatDate = (dateString) => {
          const date = new Date(dateString);
          return `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        };

        // Função de processamento principal
        const processExcelData = (data) => {
          errorMessageDiv.textContent = '';
          const requiredColumns = ['Mês/Ano', 'Subcategoria', 'Quantidade'];
          
          if (!data || data.length === 0) {
            errorMessageDiv.textContent = 'O arquivo não contém dados ou a planilha está vazia.';
            return null;
          }

          // Verificar se as colunas necessárias existem (case-insensitive)
          const headers = Object.keys(data[0]);
          const monthYearCol = headers.find(h => h.toLowerCase() === 'mês/ano');
          const subcategoryCol = headers.find(h => h.toLowerCase() === 'subcategoria');
          const quantityCol = headers.find(h => h.toLowerCase() === 'quantidade');

          if (!monthYearCol || !subcategoryCol || !quantityCol) {
            errorMessageDiv.textContent = `Erro: Certifique-se de que a planilha contém as colunas: ${requiredColumns.join(', ')}.`;
            return null;
          }

          const groupedData = {};
          const totalByCategory = {};

          data.forEach(row => {
            let monthYear = row[monthYearCol];
            const subcategory = String(row[subcategoryCol]);
            const quantity = parseFloat(row[quantityCol]);

            if (isNaN(quantity)) return; // Ignora linhas sem quantidade válida

            // Normaliza a data para MM/AAAA se vier como data completa
            if (typeof monthYear === 'string' && monthYear.includes('-')) {
              // Assume o formato YYYY-MM-DD
              monthYear = formatDate(monthYear);
            } else if (typeof monthYear === 'number') {
              // Tratamento para números de data do Excel (pode precisar de ajuste dependendo da biblioteca XLSX)
              const date = new Date(Math.round((monthYear - 25569) * 86400 * 1000));
              monthYear = `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
            }

            if (!monthYear || !subcategory) return; // Ignora se a data ou subcategoria estiver faltando

            if (!groupedData[monthYear]) {
              groupedData[monthYear] = {};
            }
            if (!groupedData[monthYear][subcategory]) {
              groupedData[monthYear][subcategory] = 0;
            }
            groupedData[monthYear][subcategory] += quantity;

            // Para o gráfico de pizza/rosca (Total Geral)
            if (!totalByCategory[subcategory]) {
              totalByCategory[subcategory] = 0;
            }
            totalByCategory[subcategory] += quantity;
          });

          // Prepara dados para o gráfico
          const months = Object.keys(groupedData).sort();
          const allSubcategories = new Set();
          months.forEach(month => {
            Object.keys(groupedData[month]).forEach(sub => allSubcategories.add(sub));
          });
          const subcategories = Array.from(allSubcategories).sort();

          // Calcula a quantidade total por mês para a tabela
          const monthlyTotals = months.map(month => ({
            month: month,
            total: subcategories.reduce((sum, sub) => sum + (groupedData[month][sub] || 0), 0)
          }));

          // Mapeia cores
          const colorMap = subcategories.reduce((map, sub) => {
            map[sub] = dynamicColors();
            return map;
          }, {});

          return { months, subcategories, groupedData, monthlyTotals, totalByCategory, colorMap };
        };

        // Função para renderizar o gráfico
        const renderChart = (data, chartType) => {
          if (!data) return;

          // Destruir o gráfico antigo se existir
          if (myChart) {
            myChart.destroy();
          }
          
          initialMessage.style.display = 'none';

          const datasets = [];
          let config = {};
          let options = {};

          if (chartType === 'bar' || chartType === 'line') {
            // GRÁFICOS DE SÉRIE TEMPORAL (Barra Empilhada e Linha)
            data.subcategories.forEach(sub => {
              const subColor = data.colorMap[sub];
              const subData = data.months.map(month => data.groupedData[month][sub] || 0);

              datasets.push({
                label: sub,
                data: subData,
                backgroundColor: subColor,
                borderColor: subColor,
                fill: chartType === 'line' ? false : true,
                stack: chartType === 'bar' ? 'Stack 1' : undefined, // Empilha apenas para barra
                type: chartType,
              });
            });

            config = {
              type: 'bar', // Força 'bar' como tipo base, mas usa o tipo definido no dataset
              data: {
                labels: data.months,
                datasets: datasets,
              },
            };
            
            options = {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                xAxes: [{ 
                  stacked: chartType === 'bar', // Eixos empilhados
                  ticks: { autoSkip: false } // Mostrar todos os meses
                }],
                yAxes: [{ 
                  stacked: chartType === 'bar',
                  ticks: { beginAtZero: true }
                }]
              },
              tooltips: {
                mode: 'index',
                intersect: false,
              },
              hover: {
                mode: 'nearest',
                intersect: true
              }
            };
          } else {
            // GRÁFICOS DE TOTAL GERAL (Pizza e Rosca)
            const totalLabels = Object.keys(data.totalByCategory);
            const totalQuantities = Object.values(data.totalByCategory);
            const totalColors = totalLabels.map(label => data.colorMap[label]);

            config = {
              type: chartType,
              data: {
                labels: totalLabels,
                datasets: [{
                  data: totalQuantities,
                  backgroundColor: totalColors,
                  borderColor: '#fff',
                  borderWidth: 1,
                }],
              },
            };
            
            options = {
              responsive: true,
              maintainAspectRatio: true, // Mantém o aspecto para rosca/pizza
              legend: {
                position: 'top',
              },
              title: {
                display: true,
                text: 'Contribuição Total das Subcategorias'
              },
              animation: {
                animateScale: true,
                animateRotate: true
              }
            };
          }

          // Cria o novo gráfico
          myChart = new Chart(chartCanvas, { ...config, options: options });
        };

        // Função para renderizar a tabela
        const renderTable = (monthlyTotals) => {
          const tableBody = document.querySelector('#data-table tbody');
          tableBody.innerHTML = '';

          if (!monthlyTotals || monthlyTotals.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3">Nenhum dado mensal consolidado encontrado.</td></tr>';
            return;
          }

          monthlyTotals.forEach((item, index) => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = item.month;
            row.insertCell().textContent = item.total.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
          });
        };

        // Manipulador de upload de arquivo
        uploadInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;

          uploadStatus.textContent = 'Processando...';

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellText: false });
              
              // Assume que os dados estão na primeira aba
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              
              // Converte para JSON
              const json = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'yyyy-mm-dd' });

              processedData = processExcelData(json);

              if (processedData) {
                renderChart(processedData, chartTypeSelect.value);
                renderTable(processedData.monthlyTotals);
                uploadStatus.textContent = `Upload bem-sucedido: ${file.name}`;
                errorMessageDiv.textContent = '';
              } else {
                uploadStatus.textContent = 'Erro de processamento.';
              }
            } catch (error) {
              errorMessageDiv.textContent = 'Erro ao ler ou processar o arquivo. Verifique se o formato está correto.';
              uploadStatus.textContent = 'Falha no Upload.';
              console.error('Erro de processamento XLSX:', error);
            }
          };
          reader.readAsArrayBuffer(file);
        });

        // Manipulador de mudança de tipo de gráfico
        chartTypeSelect.addEventListener('change', (event) => {
          if (processedData) {
            renderChart(processedData, event.target.value);
          }
        });
      });
    </script>
  </body>
</html>
